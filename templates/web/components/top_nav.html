{% load i18n static %}

<style>
/* Hide scrollbar for categories nav */
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}
.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Navigation button active state */
.nav-category-btn.active,
.nav-category-trigger:hover .nav-category-btn,
#moreCategoriesWrapper:hover .nav-category-btn {
  background-color: #e5e7eb; /* gray-200 - visible hover */
}

.dark .nav-category-btn.active,
.dark .nav-category-trigger:hover .nav-category-btn,
.dark #moreCategoriesWrapper:hover .nav-category-btn {
  background-color: #374151; /* gray-700 */
}

/* Fix for jumping text when dropdown is open */
.nav-category-trigger.is-open .nav-category-btn {
  background-color: white !important;
  border: 1px solid #e5e7eb !important; /* gray-200 */
  border-bottom: 1px solid white !important; /* Match border width to prevent jump */
  padding-bottom: calc(0.625rem + 1px) !important; /* Compensate for the bridge look if needed, but keep total height same */
  border-bottom-left-radius: 0 !important;
  border-bottom-right-radius: 0 !important;
  z-index: 60;
  position: relative;
  box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.05); 
}

.dark .nav-category-trigger.is-open .nav-category-btn {
  background-color: #1f2937 !important; /* gray-800 */
  border-color: #374151 !important; /* gray-700 */
  border-bottom-color: #1f2937 !important;
  box-shadow: 0 -4px 10px -2px rgb(0 0 0 / 0.5);
}

.category-dropdown.is-connected:not(#cartDropdown):not(#accountDropdown) {
  border-top-left-radius: 0 !important;
  margin-top: 0 !important; 
  border-top-width: 1px !important;
}

/* Align mega menu border with trigger like standard dropdowns */
#dropdownMegaMenu {
  margin-top: -1px;
  border-top-width: 0;
}

/* Ensure the dropdown overlaps properly even with different button heights */
.nav-category-trigger.is-open .nav-category-btn {
  height: calc(100% + 1px);
  margin-bottom: -1px;
}

.category-dropdown.is-connected.is-right-aligned:not(#cartDropdown):not(#accountDropdown) {
  border-top-left-radius: 0.75rem; /* Restore if right aligned */
  border-top-right-radius: 0;
}

/* Dropdown positioning - use fixed to escape overflow:hidden parent */
.category-dropdown {
  animation: fadeIn 0.15s ease-out;
}

#cartDropdown,
#accountDropdown {
  box-shadow: 0 -8px 18px -14px rgba(0, 0, 0, 0.35),
    0 18px 36px -18px rgba(0, 0, 0, 0.45),
    0 10px 20px -10px rgba(0, 0, 0, 0.25);
}

.dark #cartDropdown,
.dark #accountDropdown {
  box-shadow: 0 -10px 22px -16px rgba(0, 0, 0, 0.65),
    0 20px 40px -18px rgba(0, 0, 0, 0.7),
    0 12px 22px -12px rgba(0, 0, 0, 0.55);
}

.category-dropdown:not(#cartDropdown):not(#accountDropdown) {
  position: fixed !important;
}

/* Keep dropdowns within viewport on desktop */
@media (min-width: 768px) {
  .category-dropdown:not(#cartDropdown):not(#accountDropdown) {
    max-height: calc(100vh - 160px);
    overflow: hidden;
    overscroll-behavior: contain;
  }
}

/* Specific fade for unified dropdowns - no movement */
.category-dropdown.is-connected:not(#cartDropdown):not(#accountDropdown) {
  animation: fadeIn 0.15s ease-out;
}

/* Custom scrollbar for left column */
.custom-scrollbar::-webkit-scrollbar {
  width: 4px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: #e5e7eb;
  border-radius: 20px;
}

.dark .custom-scrollbar::-webkit-scrollbar-thumb {
  background: #374151;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: #d1d5db;
}

/* Ensure proper stacking and hover area */
.nav-category-trigger {
  position: relative;
  cursor: pointer; /* Fix: Ensure cursor stays pointer even in padding areas */
}

/* Hover bridge to keep dropdown open during transition from trigger to menu */
.nav-category-trigger::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  height: 20px;
  background: transparent;
  pointer-events: none;
  z-index: 10;
}

/* Enable bridge only when dropdown is open to prevent accidental triggers from below */
.nav-category-trigger.is-open::after {
  pointer-events: auto;
}

/* Fix: Ensure dropdown bridge does NOT block nav hover */
.category-dropdown::before {
  pointer-events: none;
  background: transparent;
}

/* Categories nav container for proper dropdown positioning */
#categories-nav {
  position: relative;
  padding-bottom: 4px; /* Tiny bit of extra space for hover */
  margin-bottom: -4px;
}

#categories-row-wrapper.is-dimmed {
  z-index: 30 !important;
  pointer-events: none;
}

/* Mobile responsiveness */
@media (max-width: 767px) {
  .category-dropdown:not(#cartDropdown):not(#accountDropdown) {
    display: none !important;
  }

  /* Desktop-only dropdowns: account stays as dropdown on mobile for now, cart becomes link */
  #cartDropdown {
    display: none !important;
  }

  #accountDropdown:not(.hidden) {
    position: fixed !important;
    top: var(--mobile-nav-offset, 64px) !important;
    left: 0 !important;
    right: 0 !important;
    width: 100vw !important;
    max-height: calc(100vh - var(--mobile-nav-offset, 64px)) !important;
    border-radius: 0 !important;
    margin-top: 0 !important;
    z-index: 50 !important;
    border-left: none !important;
    border-right: none !important;
    border-top: 1px solid #e5e7eb !important;
    box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1) !important;
    overflow-y: auto !important;
    display: flex !important;
    flex-direction: column !important;
  }

  .dark #cartDropdown, .dark #accountDropdown {
    border-top-color: #374151 !important;
  }

  html.nav-scroll-locked,
  body.nav-scroll-locked {
    overflow: hidden;
    overscroll-behavior: contain;
  }

  /* Scrollbar styles for mobile menu */
  #ecommerce-navbar-menu {
    scrollbar-width: thin;
  }

  #ecommerce-navbar-menu::-webkit-scrollbar {
    width: 6px;
  }

  #ecommerce-navbar-menu::-webkit-scrollbar-track {
    background: transparent;
  }

  #ecommerce-navbar-menu::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 999px;
  }

  .dark #ecommerce-navbar-menu::-webkit-scrollbar-thumb {
    background: #4b5563;
  }
}

html.nav-scroll-locked,
body.nav-scroll-locked {
  overflow: hidden;
  overscroll-behavior: contain;
}

/* Search results scrollbar styling */
#search-results::-webkit-scrollbar {
  width: 6px;
}

#search-category-dropdown,
#search-results {
  animation: fadeIn 0.15s ease-out;
}

#search-results::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

#search-results::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

#search-results::-webkit-scrollbar-thumb:hover {
  background: #a1a1a1;
}

/* Prevent Flowbite drawer backdrop from lingering */
[drawer-backdrop] {
  display: none !important;
}

/* Quick drawer icon visibility (desktop only) */
.drawer-quick {
  display: none;
  /* Smooth transition for opacity only */
  transition: opacity 0.3s ease-out;
}

@media (min-width: 768px) {
  /* Default hidden state on desktop */
  .drawer-quick {
    display: inline-flex;
    /* Reserve space to prevent layout shift */
    width: 2.5rem; /* ~40px */
    padding: 0.5rem; /* p-2 */
    margin: 0;
    
    opacity: 0;
    pointer-events: none;
  }

  /* Visible state - only animate opacity/scale */
  .drawer-quick.is-visible {
    opacity: 1;
    pointer-events: auto;
  }
}
</style>

{# Backdrop overlay for dropdowns #}
<div id="nav-backdrop" class="fixed inset-0 bg-black/40 z-45 transition-opacity duration-200 opacity-0 pointer-events-none" aria-hidden="true"></div>

<nav class="top-nav-standard sticky {% if draft_preview_enabled %}top-9{% else %}top-0{% endif %} z-60 bg-white dark:bg-gray-800 antialiased relative transition-shadow duration-300">
  {# Top row: Logo, Search, Cart, Account #}
  <div class="py-2.5 md:py-4 relative z-30 bg-white dark:bg-gray-800">
    <div class="max-w-7xl px-4 mx-auto 2xl:px-0">
      <div class="flex flex-wrap items-center justify-between gap-y-2.5 md:gap-x-8 lg:flex-nowrap">
        <div class="flex items-center justify-between w-full md:contents">
          <div class="flex items-center gap-2 md:contents">
            {# Mobile Menu Toggle - Left of logo #}
            <button type="button" id="mobile-menu-toggle" class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-900 dark:text-white cursor-pointer transition-colors duration-300">
              <span class="sr-only">{% translate "Menu" %}</span>
              <svg class="w-8 h-8" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 7h14M5 12h14M5 17h14"></path>
              </svg>
            </button>
            {# Logo #}
            <div class="shrink-0 md:order-1 flex items-center gap-2 relative">
              <button
                id="categories-drawer-quick"
                type="button"
                data-drawer-target="categoriesDrawer"
                data-drawer-show="categoriesDrawer"
                aria-controls="categoriesDrawer"
                class="drawer-quick absolute right-full top-1/2 -translate-y-1/2 mr-3 cursor-pointer items-center justify-center p-2 text-sm font-medium text-gray-900 dark:text-white rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200"
              >
                <span class="sr-only">{% translate "All categories" %}</span>
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5h18M3 12h18M3 19h18"></path>
                </svg>
              </button>
              <a href="{% url 'web:home' %}" title="{{ project_meta.NAME }}">
                {% if site_logo %}
                <img
                  class="w-auto h-9 md:h-16"
                  src="{{ site_logo }}"
                  alt="{{ project_meta.NAME }}"
                />
                {% endif %}
              </a>
            </div>
          </div>

          {# Right side buttons: Account, Cart, Favourites, CMS #}
          <div class="flex items-center justify-end md:order-3 gap-1">
            {# Account Button & Dropdown #}
            {% if user.is_authenticated %}
            <div class="relative nav-category-trigger" data-dropdown-target="accountDropdown">
              <a href="{% url 'users:account_details' %}" id="accountDropdownButton" title="{% translate 'Account' %}" class="nav-icon-btn inline-flex items-center justify-center w-11 h-11 gap-0 px-0 md:w-auto md:gap-1.5 md:pl-4.5 md:pr-1.5 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 cursor-pointer transition-all duration-200">
                {% if request.session.hijack_history %}
                {% with impersonated_display_name=user.email|default:user.get_username %}
                <span class="hidden md:inline text-right leading-tight" data-user-first-name>
                  <span class="block text-2.5 font-semibold uppercase tracking-wide text-amber-600 dark:text-amber-400">{% translate "Impersonation" %}</span>
                  <span class="block text-xs font-medium text-amber-700 dark:text-amber-300 normal-case tracking-normal">({{ impersonated_display_name }})</span>
                </span>
                {% endwith %}
                {% else %}
                <span class="hidden md:inline text-base font-medium text-right" data-user-first-name>{{ user.first_name }}</span>
                {% endif %}
                <span class="sr-only md:hidden">{% translate "Account" %}</span>
                <span class="relative">
                  <svg class="w-9 h-9 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M6 18v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-1a4 4 0 0 0-4-4h-4a4 4 0 0 0-4 4Zm9-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
                  </svg>
                  {% if request.session.hijack_history %}
                  <span class="absolute -top-1 -right-1 flex items-center justify-center w-4 h-4 rounded-full bg-amber-500 border-2 border-white dark:border-gray-800">
                    <svg class="w-2.5 h-2.5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01"/>
                    </svg>
                  </span>
                  {% endif %}
                </span>
              </a>

              <div id="accountDropdown" class="category-dropdown hidden absolute right-0 top-full mt-3 w-fit min-w-64 max-w-[90vw] divide-y divide-gray-100 overflow-hidden overflow-y-auto rounded-xl bg-white antialiased shadow-lg dark:divide-gray-600 dark:bg-gray-700 transition-opacity duration-300 z-50 before:absolute before:-top-10 before:h-10 before:w-full before:content-['']">
                {# User display name header #}
                <div class="px-4 py-3 cursor-text select-text">
                  <p class="text-sm font-medium text-gray-900 dark:text-white whitespace-nowrap" data-user-display-name>{{ user.email }}</p>
                </div>

                {% if request.session.hijack_history %}
                <div class="px-4 py-3 bg-amber-50 dark:bg-amber-900/30 border-y border-amber-200 dark:border-amber-800 cursor-text select-text">
                  <p class="text-xs font-semibold uppercase tracking-wide text-amber-800 dark:text-amber-300">{% translate "Impersonation active" %}</p>
                  <p class="mt-1 text-sm font-medium text-amber-900 dark:text-amber-100">
                    {% blocktranslate with email=user.email %}You are browsing in {{ email }} context.{% endblocktranslate %}
                  </p>
                  <form method="post" action="{% url 'hijack:release' %}" class="mt-2" target="_blank">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{% url 'admin:users_customuser_change' user.id %}">
                    <button type="submit" class="inline-flex items-center gap-1.5 text-sm font-medium text-amber-900 dark:text-amber-200 hover:underline cursor-pointer">
                      <svg class="w-4 h-4" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4"/>
                      </svg>
                      <span>{% translate "Open this user in Admin" %}</span>
                    </button>
                  </form>
                </div>
                {% endif %}

                <ul class="p-1.5 text-start text-sm font-medium text-gray-900 dark:text-white">
                  <li>
                    <a href="{% url 'users:account_details' %}" class="group flex items-center gap-2 rounded-lg px-3 py-2 text-gray-700 hover:bg-gray-200 dark:text-gray-200 dark:hover:bg-gray-600 transition-colors duration-150">
                      <svg class="h-5 w-5 text-gray-700 group-hover:text-gray-900 dark:text-gray-200 dark:group-hover:text-white transition-colors duration-150" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <path stroke="currentColor" stroke-width="1.5" d="M7 17v1c0 .6.4 1 1 1h8c.6 0 1-.4 1-1v-1a3 3 0 0 0-3-3h-4a3 3 0 0 0-3 3Zm8-9a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"></path>
                      </svg>
                      <span class="text-sm font-medium">{% translate "My Account" %}</span>
                    </a>
                  </li>
                </ul>

                <div class="p-1.5">
                  <a href="{% url 'account_logout' %}" class="group flex items-center gap-2 rounded-lg px-3 py-2 text-red-600 hover:bg-gray-200 dark:text-red-400 dark:hover:bg-gray-600 transition-colors duration-150">
                    <svg class="h-5 w-5 transition-colors duration-150" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 12H8m12 0-4 4m4-4-4-4M9 4H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h2"></path>
                    </svg>
                    <span class="text-sm font-medium">{% translate "Sign Out" %}</span>
                  </a>
                </div>
              </div>
            </div>
            {% else %}
            <a
              id="nav-sign-in-link"
              href="{% url 'account_login' %}"
              data-login-url="{% url 'account_login' %}"
              title="{% translate 'Sign In' %}"
              class="nav-icon-btn inline-flex items-center justify-center w-11 h-11 gap-0 px-0 md:w-auto md:gap-1.5 md:pl-4.5 md:pr-1.5 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 transition-all duration-200"
            >
              <span class="hidden md:inline text-base font-medium">{% translate "Sign In" %}</span>
              <span class="sr-only md:hidden">{% translate "Sign In" %}</span>
              <svg class="w-9 h-9 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M6 18v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1v-1a4 4 0 0 0-4-4h-4a4 4 0 0 0-4 4Zm9-10a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
              </svg>
            </a>
            {% endif %}

            {% if user.is_staff %}
            <a
              href="{% url 'admin:index' %}"
              title="CMS"
              class="nav-icon-btn inline-flex items-center justify-center w-11 h-11 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 cursor-pointer transition-all duration-200"
            >
              <svg
                class="w-8 h-8"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                fill="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  fill-rule="evenodd"
                  d="M4.857 3A1.857 1.857 0 0 0 3 4.857v4.286C3 10.169 3.831 11 4.857 11h4.286A1.857 1.857 0 0 0 11 9.143V4.857A1.857 1.857 0 0 0 9.143 3H4.857Zm10 0A1.857 1.857 0 0 0 13 4.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 21 9.143V4.857A1.857 1.857 0 0 0 19.143 3h-4.286Zm-10 10A1.857 1.857 0 0 0 3 14.857v4.286C3 20.169 3.831 21 4.857 21h4.286A1.857 1.857 0 0 0 11 19.143v-4.286A1.857 1.857 0 0 0 9.143 13H4.857Zm10 0A1.857 1.857 0 0 0 13 14.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 21 19.143v-4.286A1.857 1.857 0 0 0 19.143 13h-4.286Z"
                  clip-rule="evenodd"
                />
              </svg>
              <span class="sr-only">CMS</span>
            </a>
            {% endif %}

            {# Favourites Button â€” visible for all users (anonymous uses session) #}
            <a
              href="{% url 'favourites:favourites_page' %}"
              title="{% translate 'Favourites' %}"
              class="nav-icon-btn inline-flex items-center justify-center w-11 h-11 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 cursor-pointer transition-all duration-200"
            >
              <svg class="w-8 h-8" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6C6.5 1 1 8 5.8 13l6.2 7 6.2-7C23 8 17.5 1 12 6Z"></path>
              </svg>
              <span class="sr-only">{% translate "Favourites" %}</span>
            </a>

            {# Cart Button #}
            <div class="relative {% if not disable_cart_dropdown %}nav-category-trigger{% endif %}"
              {% if not disable_cart_dropdown %}
              data-dropdown-target="cartDropdown"
              {% endif %}>
              <a
                href="/cart/"
                id="cartDropdownButton"
                title="{% translate 'Cart' %}"
                class="nav-icon-btn inline-flex items-center justify-center w-11 h-11 rounded-full hover-bg btn-press text-gray-700 dark:text-gray-200 cursor-pointer transition-all duration-200 relative"
              >
                <span class="sr-only">{% translate "Cart" %}</span>
                <svg class="w-8 h-8" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 4h1.5L9 16m0 0h8m-8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm8 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm-8.5-3h9.25L19 7H7.312"></path>
                </svg>
                {% if nav_cart_count %}
                <span data-cart-badge class="absolute -top-1 -right-1 flex items-center justify-center min-w-5 h-5 px-1.5 text-xs font-bold text-white bg-primary-600 rounded-full leading-none">{{ nav_cart_count }}</span>
                {% endif %}
              </a>


            {# Cart Dropdown #}
            {% if not disable_cart_dropdown %}
            <div id="cartDropdown" class="category-dropdown hidden absolute right-0 top-full mt-3 w-[calc(100vw-1rem)] max-w-96 divide-y divide-gray-200 overflow-hidden rounded-lg bg-white antialiased shadow-lg dark:divide-gray-600 dark:bg-gray-700 transition-opacity duration-300 z-50 before:absolute before:-top-10 before:h-10 before:w-full before:content-['']">
              <div class="p-4 bg-gray-50 dark:bg-gray-800">
                <dl class="flex items-center gap-2">
                  <dt class="font-bold text-gray-900 dark:text-white underline decoration-primary-600 underline-offset-8 decoration-2 dark:decoration-primary-500">{% translate "Shopping cart" %}</dt>
                  <dd data-cart-lines-number data-lines_number="{{ nav_cart_count }}" data-label-items="{% translate 'items' %}" class="text-gray-500 dark:text-gray-400 font-medium" {% if not nav_cart_count %}style="display: none;"{% endif %}>({{ nav_cart_count }} {% translate "items" %})</dd>
                </dl>
              </div>

              <div class="max-h-96 overflow-y-auto overflow-x-hidden cursor-pointer">
                <div id="nav-cart-lines" class="divide-y divide-gray-200 dark:divide-gray-600">
                  {% if nav_cart_lines %}
                    {% for line in nav_cart_lines %}
                      {% include "Cart/nav_cart_line.html" with line=line %}
                    {% endfor %}
                  {% endif %}

                  <div
                    data-cart-empty-state
                    class="p-4 py-8 text-center {% if nav_cart_lines %}hidden{% endif %}"
                  >
                    <p class="text-base font-semibold text-gray-700 dark:text-gray-200">{% translate "Your cart is empty" %}</p>
                    <p class="mt-1 text-subtitle">{% translate "Continue shopping and add items to start checkout." %}</p>
                  </div>
                </div>
              </div>

              <div
                data-cart-summary-footer
                class="p-4 space-y-3 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-600 {% if not nav_cart_lines %}hidden{% endif %}"
              >
                <div class="flex items-center justify-between text-lg font-bold text-gray-900 dark:text-white">
                  <span>{% translate "Total" %}</span>
                  <span data-cart-total data-price="{{ nav_cart_total }}" data-currency="{{ site_currency }}">{{ nav_cart_total }}</span>
                </div>
                <a href="{% url 'cart:cart_page' %}" class="inline-flex w-full items-center justify-center rounded-lg bg-primary-700 px-5 py-2.5 text-sm font-medium text-white hover:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 transition-colors duration-300" role="button">
                  {% translate "See your cart" %}
                </a>
              </div>
            </div>
            {% endif %}
          </div>
      </div>
      </div>

        {# Search Bar with Category Dropdown #}
        <div class="w-full md:w-auto md:flex-1 md:order-2 relative" id="search-container">
          <label for="navbar-search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">{% translate "Search" %}</label>
          <div class="relative flex items-center group bg-gray-100 dark:bg-gray-700 rounded-lg transition-shadow duration-150 ease-in focus-within:shadow-[0_4px_8px_0_rgba(0,0,0,0.16),0_0_2px_1px_rgba(0,0,0,0.08)] focus-within:bg-white dark:focus-within:bg-gray-600">
            {# Search Input #}
            <div class="relative flex-1">
              <input type="hidden" id="search-category-id" value="" />
              <input type="hidden" id="search-category-slug" value="" />
              <input
                type="text"
                id="navbar-search"
                class="block w-full py-2 md:py-3.5 text-base md:text-sm text-gray-900 border-none rounded-lg md:rounded-r-none ps-6 pe-14 bg-transparent focus:ring-0 placeholder:font-medium dark:placeholder-gray-400 dark:text-white"
                placeholder="{% translate "Search products..." %}"
                autocomplete="off"
              />
              <div id="search-loading" class="hidden absolute right-11 top-1/2 -translate-y-1/2">
                <svg class="animate-spin h-5 w-5 text-primary-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
              <button type="button" id="search-clear" class="hidden absolute right-2.5 top-1/2 -translate-y-1/2 p-2 text-gray-400 hover:text-gray-900 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded-full transition-colors cursor-pointer">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <span class="sr-only">{% translate "Clear search" %}</span>
              </button>
            </div>

            {# Separator #}
            <div class="hidden md:block w-px h-7 bg-gray-300 dark:bg-gray-600 self-center opacity-50"></div>

            {# Category Dropdown - Desktop only #}
            <div class="hidden md:block relative px-2" id="search-category-wrapper">
              <button type="button" id="search-category-btn" class="flex items-center gap-2 px-4 py-2 my-2 text-sm font-medium text-gray-500 dark:text-gray-400 bg-transparent hover:bg-gray-200 dark:hover:bg-gray-700/50 hover:text-gray-900 dark:hover:text-white transition-colors cursor-pointer whitespace-nowrap rounded-lg">
                <span id="search-category-label">{% translate "All categories" %}</span>
                <svg class="w-2 h-2 transition-transform duration-200 text-gray-400" id="search-category-arrow" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                </svg>
              </button>
              {# Category Dropdown Menu #}
              <div id="search-category-dropdown" class="hidden absolute top-full right-0 mt-1 min-w-64 bg-white dark:bg-gray-800 rounded-lg shadow-2xl border border-gray-100 dark:border-gray-700 z-50 max-h-80 overflow-y-auto">
                <div class="py-1">
                  <button type="button" data-category-id="" data-category-name="{% translate 'All categories' %}" class="search-category-option w-full text-left px-4 py-2.5 text-sm font-medium text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors cursor-pointer">
                    {% translate "All categories" %}
                  </button>
                  <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
                  {% for category in nav_categories %}
                  <button type="button" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}" data-category-slug="{{ category.slug }}" class="search-category-option w-full text-left px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors cursor-pointer">
                    {{ category.name }}
                  </button>
                  {% endfor %}
                </div>
              </div>
            </div>

            {# Search Button Icon #}
            <div class="hidden md:flex items-center p-1">
              <button
                type="button"
                id="search-btn-desktop"
                onmousedown="event.preventDefault()"
                class="flex items-center justify-center w-10 h-10 bg-primary-600 text-white rounded-md hover:bg-primary-700 active:scale-95 transition-all duration-200 cursor-pointer border-none"
              >
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"></path>
                </svg>
              </button>
            </div>
          </div>

          {# Search Results Dropdown #}
          <div id="search-results" class="hidden absolute left-0 right-0 mt-1 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 max-h-96 overflow-y-auto z-100 cursor-pointer">
            <div id="search-results-content">
              {# Content will be dynamically populated #}
            </div>
          </div>
        </div>

        {# Mobile Menu - Full Screen Overlay #}
        <div id="ecommerce-navbar-menu" class="fixed inset-0 z-50 bg-white dark:bg-gray-800 hidden md:hidden flex-col">
          {# Mobile Menu Header #}
          <div class="flex items-center justify-between px-4 py-4 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">{% translate "Categories" %}</h2>
            <button type="button" id="mobile-menu-close" class="p-2 text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-colors duration-200">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
              <span class="sr-only">{% translate "Close menu" %}</span>
            </button>
          </div>
          {# Mobile Menu Content - Scrollable #}
          <div class="flex-1 overflow-y-auto">
            <ul class="p-3 text-gray-900 dark:text-white text-base font-medium space-y-0.5">
              <li>
                <a href="{% url 'web:home' %}" class="flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">
                  <svg class="w-5 h-5 mr-3 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                  </svg>
                  {% translate "Home" %}
                </a>
              </li>
              {% if navbar_mode == 'custom' %}
              {# Custom navbar mode - show custom items in mobile menu #}
              {% for item in custom_navbar_items %}
              {% if item.item_type == 'separator' %}
              <li class="py-2">
                <hr class="border-gray-200 dark:border-gray-600">
              </li>
              {% elif item.item_type == 'custom_link' %}
              <li>
                <a href="{{ item.url }}" {% if item.open_in_new_tab %}target="_blank" rel="noopener noreferrer"{% endif %} class="flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" {% if item.label_color %}style="color: {{ item.label_color }};"{% endif %}>
                  {% if item.icon %}<span class="mr-3">{{ item.icon }}</span>{% endif %}
                  {{ item.label }}
                </a>
              </li>
              {% elif item.item_type == 'dynamic_page' and item.dynamic_page %}
              <li>
                <a href="{{ item.get_url }}" {% if item.open_in_new_tab %}target="_blank" rel="noopener noreferrer"{% endif %} class="flex items-center px-3 py-2.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" {% if item.label_color %}style="color: {{ item.label_color }};"{% endif %}>
                  {% if item.icon %}<span class="mr-3">{{ item.icon }}</span>{% endif %}
                  {{ item.get_display_label }}
                </a>
              </li>
              {% elif item.item_type == 'category' and item.category %}
              <li class="mobile-category-item">
                <div class="flex items-center">
                  <a href="{{ item.category.get_absolute_url }}" class="flex-1 px-3 py-2.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200" {% if item.label_color %}style="color: {{ item.label_color }};"{% endif %}>
                    {% if item.icon %}<span class="mr-2">{{ item.icon }}</span>{% endif %}
                    {{ item.get_display_label }}
                  </a>
                  {% if item.has_children %}
                  <button type="button" class="mobile-category-toggle p-2.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-colors duration-200">
                    <svg class="w-5 h-5 transition-transform duration-300 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  {% endif %}
                </div>
                {% if item.has_children %}
                <ul class="hidden ml-3 mt-0.5 space-y-0.5 border-l-2 border-gray-200 dark:border-gray-600">
                  {% for child in item.category.children.all %}
                  <li>
                    <div class="flex items-center">
                      <a href="{{ child.get_absolute_url }}" class="flex-1 px-2.5 py-2 ml-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200 text-base">{{ child.name }}</a>
                      {% if child.children.all %}
                      <button type="button" class="mobile-category-toggle p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-colors duration-200">
                        <svg class="w-4 h-4 transition-transform duration-300 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      {% endif %}
                    </div>
                    {% if child.children.all %}
                    <ul class="hidden ml-3 mt-0.5 space-y-0.5 border-l-2 border-gray-100 dark:border-gray-700">
                      {% for subchild in child.children.all %}
                      <li>
                        <a href="{{ subchild.get_absolute_url }}" class="block px-2.5 py-1.5 ml-2 text-base text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200">{{ subchild.name }}</a>
                      </li>
                      {% endfor %}
                    </ul>
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
                {% endif %}
              </li>
              {% endif %}
              {% endfor %}
              {% else %}
              {# Default navbar mode - show categories alphabetically #}
              {% for category in nav_categories %}
              <li class="mobile-category-item">
                <div class="flex items-center">
                  <a href="{{ category.get_absolute_url }}" class="flex-1 px-3 py-2.5 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200">{{ category.name }}</a>
                  {% if category.children.all %}
                  <button type="button" class="mobile-category-toggle p-2.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-colors duration-200">
                    <svg class="w-5 h-5 transition-transform duration-300 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>
                  {% endif %}
                </div>
                {% if category.children.all %}
                <ul class="hidden ml-3 mt-0.5 space-y-0.5 border-l-2 border-gray-200 dark:border-gray-600">
                  {% for child in category.children.all %}
                  <li>
                    <div class="flex items-center">
                      <a href="{{ child.get_absolute_url }}" class="flex-1 px-2.5 py-2 ml-2 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200 text-base">{{ child.name }}</a>
                      {% if child.children.all %}
                      <button type="button" class="mobile-category-toggle p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg cursor-pointer transition-colors duration-200">
                        <svg class="w-4 h-4 transition-transform duration-300 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                      </button>
                      {% endif %}
                    </div>
                    {% if child.children.all %}
                    <ul class="hidden ml-3 mt-0.5 space-y-0.5 border-l-2 border-gray-100 dark:border-gray-700">
                      {% for subchild in child.children.all %}
                      <li>
                        <a href="{{ subchild.get_absolute_url }}" class="block px-2.5 py-1.5 ml-2 text-base text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200">{{ subchild.name }}</a>
                      </li>
                      {% endfor %}
                    </ul>
                    {% endif %}
                  </li>
                  {% endfor %}
                </ul>
                {% endif %}
              </li>
              {% endfor %}
              {% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Categories Navigation Row Container - NOT absolute, part of document flow #}



</nav>

{# MOVED Categories Navigation Row Container #}
  <div class="hidden md:block relative w-full z-40" id="categories-row-wrapper" data-navbar-mode="{{ navbar_mode }}" style="transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; will-change: transform, opacity;">
    {# Categories Navigation Bar #}
    <div class="py-3 w-full bg-white dark:bg-gray-800 shadow-md" id="categories-nav-wrapper">
    <div id="categories-nav-container" class="px-3 relative mx-auto 2xl:px-0 max-w-7xl">
      <div class="flex gap-0 items-center overflow-hidden" id="categories-nav" data-navbar-mode="{{ navbar_mode }}" data-total-categories="{% if navbar_mode == 'custom' %}{{ custom_navbar_items|length }}{% else %}{{ nav_categories|slice:':10'|length }}{% endif %}">
        {# More Categories Drawer Trigger - Fixed at the beginning #}
        <div id="moreCategoriesWrapper" class="shrink-0 flex items-center px-0.5 border-r border-gray-200 dark:border-gray-700 mr-0.5 h-full">
          <button id="moreCategoriesButton" type="button" data-drawer-target="categoriesDrawer" data-drawer-show="categoriesDrawer" aria-controls="categoriesDrawer" class="nav-category-btn inline-flex items-center gap-2 text-sm font-medium text-gray-900 dark:text-white cursor-pointer whitespace-nowrap px-3 py-2.5 rounded-lg border border-transparent transition-colors duration-200">
            <svg class="w-4 h-4 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h18M3 12h18M3 19h18"></path>
            </svg>
            <span>{% translate "All categories" %}</span>
          </button>
        </div>

        {% if navbar_mode == 'custom' %}
        {# Custom navbar mode - show user-defined items #}
        {% for item in custom_navbar_items %}
        {% include "web/components/navbar_custom_item.html" with item=item loop_index=forloop.counter %}
        {% endfor %}
        {% else %}
        {# Default navbar mode - show categories alphabetically #}
        {% for category in nav_categories|slice:':10' %}
        <div class="shrink-0 nav-category-trigger nav-priority-item px-0.5 flex items-center {% if category.children.all %}has-children{% endif %}" data-category-id="{{ category.id }}" data-dropdown-target="categoryDropdown{{ category.id }}">
          {# Category name is always a clickable link #}
          <a href="{{ category.get_absolute_url }}" class="nav-category-btn inline-flex items-center gap-1 text-sm font-medium text-gray-900 dark:text-white cursor-pointer whitespace-nowrap px-3 py-2.5 rounded-lg border border-transparent transition-colors duration-200">
            <span>{{ category.name }}</span>
            {% if category.children.all %}
            <svg class="nav-dropdown-arrow w-4 h-4 transition-transform duration-300" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 9-7 7-7-7"></path>
            </svg>
            {% endif %}
          </a>
        </div>
        {% endfor %}
        {% endif %}
      </div>

    </div>
  </div>
  </div>

  {# Categories Drawer #}
  <div id="categoriesDrawer" class="fixed top-0 left-0 z-80 h-screen p-4 overflow-y-auto transition-transform -translate-x-full bg-white w-80 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 shadow-2xl" tabindex="-1" aria-labelledby="drawer-label" data-drawer-body-scrolling="true" data-drawer-backdrop="false">
    <div class="flex items-center justify-between mb-4">
        <h5 id="drawer-label" class="text-base font-semibold text-gray-700 uppercase dark:text-gray-200">{% translate "All Categories" %}</h5>
        <button type="button" data-drawer-hide="categoriesDrawer" aria-controls="categoriesDrawer" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 inline-flex items-center justify-center dark:hover:bg-gray-700 dark:hover:text-white cursor-pointer">
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
            <span class="sr-only">{% translate "Close menu" %}</span>
        </button>
    </div>
    <div class="py-2">
      <ul class="space-y-2 font-medium">
        {% for category in nav_categories %}
          {% include "web/components/category_drawer_item.html" with item=category padding=1 %}
        {% endfor %}
      </ul>
    </div>
  </div>


  {# Category Dropdowns Container - Moved to body level #}
  <div id="category-dropdowns-container" class="relative z-50">
    {% for category in nav_categories %}
    {% if category.children.all %}
    <div id="categoryDropdown{{ category.id }}" class="category-dropdown is-connected transition-opacity duration-300 hidden absolute left-0 w-162.5 bg-white dark:bg-gray-800 rounded-lg shadow-2xl border border-gray-200 dark:border-gray-700 z-50 before:absolute before:-top-10 before:h-10 before:w-full before:content-['']">
        <div class="flex h-full min-h-95 overflow-hidden rounded-lg">
          <!-- Left Column: Categories -->
          <div class="w-1/2 border-r border-gray-100 dark:border-gray-700 p-3 flex flex-col bg-white dark:bg-gray-800">
            <div class="mb-2 px-2">
                <a href="{{ category.get_absolute_url }}" class="subcategory-item flex items-center gap-2 px-3 py-2 text-sm font-extrabold text-gray-900 dark:text-white hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200"
                  data-preview-title="{{ category.name }}"
                  data-preview-url="{{ category.get_absolute_url }}" 
                  data-has-children="false"
                  data-parent-id="{{ category.id }}">
                {% translate "All" %} {{ category.name }}
              </a>
            </div>
            <ul class="flex-1 overflow-y-auto max-h-100 cursor-pointer space-y-0.5 p-1 custom-scrollbar">
              {% for child in category.children.all %}
              <li class="subcategory-item group cursor-pointer" 
                  data-preview-title="{{ child.name }}"
                  data-preview-url="{{ child.get_absolute_url }}" 
                  data-has-children="{% if child.children.all %}true{% else %}false{% endif %}"
                  data-parent-id="{{ category.id }}">
                <a href="{{ child.get_absolute_url }}" class="flex items-center justify-between px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 group-hover:bg-gray-200 dark:group-hover:bg-gray-700 rounded-lg transition-colors duration-200">
                  <span>{{ child.name }}</span>
                  {% if child.children.all %}
                  <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600 dark:group-hover:text-gray-300 transition-colors duration-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7"/>
                  </svg>
                  {% endif %}
                </a>
                
                {% if child.children.all %}
                <div class="hidden sub-children-data">
                  {% include "web/components/category_mega_tree.html" with items=child.children.all indent=1 %}
                </div>
                {% endif %}
              </li>
              {% endfor %}
            </ul>
          </div>
          
          <!-- Right Column: Previews -->
          <div id="previewPane{{ category.id }}" class="w-1/2 bg-gray-50 dark:bg-gray-900 flex flex-col justify-center items-center text-center relative overflow-hidden group/preview" data-category-icon-url="{% if category.image %}{{ category.image.url }}{% endif %}">
             <!-- Default State -->
             <div id="preview-default-{{ category.id }}" class="subcategory-preview-default p-6 transition-all duration-300 transform scale-100 opacity-100 z-10 flex flex-col items-center">
               {% if category.image %}
                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 transition-transform duration-500 group-hover/preview:scale-110 text-gray-700 dark:text-gray-200">
                  <img src="{{ category.image.url }}" alt="{{ category.name }}" class="w-10 h-10 object-contain" loading="lazy">
                </div>
               {% elif nav_category_preview_icon %}
                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 transition-transform duration-500 group-hover/preview:scale-110 text-gray-700 dark:text-gray-200">
                  <span class="text-3xl leading-none">{{ nav_category_preview_icon }}</span>
                </div>
               {% else %}
                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 transition-transform duration-500 group-hover/preview:scale-110 text-gray-500 dark:text-gray-400">
                  <svg class="w-10 h-10" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                    <rect x="4" y="4" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
                    <rect x="14" y="4" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
                    <rect x="4" y="14" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
                    <rect x="14" y="14" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
                  </svg>
                </div>
               {% endif %}
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">{{ category.name }}</h3>
                <a href="{{ category.get_absolute_url }}" class="inline-flex items-center justify-center w-auto px-6 py-2.5 bg-primary-700 text-white hover:bg-primary-800 text-sm font-bold rounded-lg transition-colors duration-300 shadow-sm">
                  {% translate "Go to" %} {{ category.name }}
                </a>
             </div>
          </div>
        </div>
      </div>
      {% endif %}
    {% endfor %}
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ===========================
  // SEARCH FUNCTIONALITY
  // ===========================
  const searchInput = document.getElementById('navbar-search');
  const searchResults = document.getElementById('search-results');
  const searchResultsContent = document.getElementById('search-results-content');
  const searchLoading = document.getElementById('search-loading');
  const searchContainer = document.getElementById('search-container');
  const navCategoryPreviewIcon = "{{ nav_category_preview_icon|default:''|escapejs }}";

  function escapeHtml(value) {
    return String(value)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function getCategoryPreviewBadgeHtml(iconUrl = '') {
    const normalizedIconUrl = String(iconUrl || '').trim();
    if (normalizedIconUrl) {
      return `
      <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-700 dark:text-gray-200">
        <img src="${escapeHtml(normalizedIconUrl)}" alt="" class="w-10 h-10 object-contain" loading="lazy">
      </div>
      `;
    }

    if (navCategoryPreviewIcon) {
      return `
      <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-700 dark:text-gray-200">
        <span class="text-3xl leading-none">${escapeHtml(navCategoryPreviewIcon)}</span>
      </div>
      `;
    }

    return `
      <div class="w-16 h-16 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-4 text-gray-500 dark:text-gray-400">
        <svg class="w-10 h-10" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <rect x="4" y="4" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
          <rect x="14" y="4" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
          <rect x="4" y="14" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
          <rect x="14" y="14" width="6" height="6" rx="1.5" stroke="currentColor" stroke-width="1.7"></rect>
        </svg>
      </div>
    `;
  }

  let searchTimeout = null;
  let currentQuery = '';
  let selectedIndex = -1;
  let suggestions = [];

  // ===========================
  // SEARCH CATEGORY DROPDOWN
  // ===========================
  const searchCategoryBtn = document.getElementById('search-category-btn');
  const searchCategoryDropdown = document.getElementById('search-category-dropdown');
  const searchCategoryLabel = document.getElementById('search-category-label');
  const searchCategoryArrow = document.getElementById('search-category-arrow');
  const searchCategoryIdInput = document.getElementById('search-category-id');
  const searchCategorySlugInput = document.getElementById('search-category-slug');
  const searchCategoryOptions = document.querySelectorAll('.search-category-option');

  if (searchCategoryBtn && searchCategoryDropdown) {
    // Toggle dropdown
    searchCategoryBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      const isHidden = searchCategoryDropdown.classList.contains('hidden');
      searchCategoryDropdown.classList.toggle('hidden');
      // Toggle active background
      searchCategoryBtn.classList.toggle('bg-gray-100', isHidden);
      searchCategoryBtn.classList.toggle('dark:bg-gray-600', isHidden);
      if (searchCategoryArrow) {
        searchCategoryArrow.classList.toggle('rotate-180', isHidden);
      }
      
      // Hide results dropdown immediately when opening category selector
      if (searchResults && isHidden) {
        searchResults.classList.add('hidden');
      }
    });

    // Handle category selection
    searchCategoryOptions.forEach(option => {
      option.addEventListener('click', function() {
        const categoryId = this.dataset.categoryId || '';
        const categoryName = this.dataset.categoryName || '{% translate "All categories" %}';
        const categorySlug = this.dataset.categorySlug || '';
        
        if (searchCategoryLabel) searchCategoryLabel.textContent = categoryName;
        if (searchCategoryIdInput) searchCategoryIdInput.value = categoryId;
        if (searchCategorySlugInput) searchCategorySlugInput.value = categorySlug;
        
        searchCategoryDropdown.classList.add('hidden');
        searchCategoryBtn.classList.remove('bg-gray-100', 'dark:bg-gray-600');
        if (searchCategoryArrow) searchCategoryArrow.classList.remove('rotate-180');
        
        // Hide results dropdown immediately upon category change
        if (searchResults) {
          searchResults.classList.add('hidden');
        }
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchCategoryBtn.contains(e.target) && !searchCategoryDropdown.contains(e.target)) {
        searchCategoryDropdown.classList.add('hidden');
        searchCategoryBtn.classList.remove('bg-gray-100', 'dark:bg-gray-600');
        if (searchCategoryArrow) searchCategoryArrow.classList.remove('rotate-180');
      }
    });
  }

  // Show all categories functionality
  const showAllBtn = document.getElementById('showAllCategoriesBtn');
  const allCategoriesSection = document.getElementById('allCategoriesSection');

  if (showAllBtn && allCategoriesSection) {
    showAllBtn.addEventListener('click', function() {
      allCategoriesSection.classList.toggle('hidden');
      const isHidden = allCategoriesSection.classList.contains('hidden');
      showAllBtn.innerHTML = isHidden
        ? `{% translate "See all categories" %} <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 12H5m14 0-4 4m4-4-4-4"></path></svg>`
        : `{% translate "Show less" %} <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12l4-4m-4 4 4 4"></path></svg>`;
    });
  }

  if (searchInput && searchResults && searchResultsContent) {
    const searchClearBtn = document.getElementById('search-clear');

    function showLoading(show) {
      if (searchLoading) {
        searchLoading.classList.toggle('hidden', !show);
      }
    }

    function updateClearButton() {
      if (searchClearBtn) {
        if (searchInput.value.trim().length > 0) {
          searchClearBtn.classList.remove('hidden');
        } else {
          searchClearBtn.classList.add('hidden');
        }
      }
    }

    function clearSearch() {
      searchInput.value = '';
      searchResults.classList.add('hidden');
      currentQuery = '';
      suggestions = [];
      selectedIndex = -1;
      updateClearButton();
      searchInput.focus();
    }

    if (searchClearBtn) {
      searchClearBtn.addEventListener('click', clearSearch);
    }

    const searchBtn = document.getElementById('search-btn-desktop');
    if (searchBtn) {
      searchBtn.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (query.length >= 1) {
          navigateToSearch(query);
        }
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function highlightMatch(text, query) {
      // Highlight logic: make everything EXCEPT the query bold
      // The query itself stays normal weight (lighter)
      if (!query) return `<strong>${escapeHtml(text)}</strong>`;
      const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${escapedQuery})`, 'gi');
      const escapedText = escapeHtml(text);
      // Split by query (capturing group keeps the delimiters)
      const parts = escapedText.split(regex);
      return parts.map((part) => {
        if (!part) return '';
        // Check if this part matches the query (case-insensitive)
        if (part.toLowerCase() === query.toLowerCase()) {
          return part; // Query match - normal weight (not bold)
        }
        return `<strong>${part}</strong>`; // Non-matching parts - bold
      }).join('');
    }

    function updateSelection() {
      const items = searchResultsContent.querySelectorAll('[data-suggestion-item]');
      items.forEach((item, index) => {
        if (index === selectedIndex) {
          item.classList.add('bg-gray-100', 'dark:bg-gray-700');
        } else {
          item.classList.remove('bg-gray-100', 'dark:bg-gray-700');
        }
      });
    }

    function navigateToSearch(query, productId = null) {
      const categorySlug = searchCategorySlugInput?.value || '';
      let url = '{% url "web:search_results" %}?q=' + encodeURIComponent(query);
      if (categorySlug) {
        url += '&category=' + encodeURIComponent(categorySlug);
      }
      if (productId) {
        url += '&product_id=' + productId;
      }
      window.location.href = url;
    }

    function renderSearchResults(data) {
      const { suggestions: suggestionsList, total_count, query } = data;
      suggestions = suggestionsList || [];
      selectedIndex = -1;

      if (suggestions.length === 0) {
        searchResultsContent.innerHTML = `
          <div class="p-4 text-center text-sm text-gray-500 dark:text-gray-400">
            {% translate "No results found for" %} "<strong>${escapeHtml(query)}</strong>"
          </div>
        `;
        searchResults.classList.remove('hidden');
        return;
      }

      let html = '';

      // Header - "Wyszukiwania" (Searches)
      html += `
        <div class="sticky top-0 z-10 px-4 py-2 bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
          <span class="text-xs font-semibold uppercase text-gray-500 dark:text-gray-400">{% translate "Searches" %}</span>
        </div>
      `;

      // Suggestion items - text only with search icon
      suggestions.forEach((item, index) => {
        const categoryInfo = item.category_name ? ` {% translate "in" %} <span class="font-semibold">${escapeHtml(item.category_name)}</span>` : '';
        html += `
          <div data-suggestion-item data-product-id="${item.id}" data-query="${escapeHtml(item.text)}" 
               class="flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 relative z-0">
            <svg class="w-4 h-4 text-gray-400 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"></path>
            </svg>
            <span class="text-sm text-gray-900 dark:text-white">${highlightMatch(item.text, query)}${categoryInfo ? `<span class="text-gray-500 dark:text-gray-400 text-xs ml-2">${categoryInfo}</span>` : ''}</span>
          </div>
        `;
      });

      // Footer with "See all results" if there are more
      if (total_count > suggestions.length) {
        const categorySlug = searchCategorySlugInput?.value || '';
        const seeAllUrl = categorySlug 
          ? `{% url 'web:search_results' %}?q=${encodeURIComponent(query)}&category=${encodeURIComponent(categorySlug)}`
          : `{% url 'web:search_results' %}?q=${encodeURIComponent(query)}`;
        html += `
          <div class="sticky bottom-0 z-10 px-4 py-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <a href="${seeAllUrl}" class="text-sm font-medium text-primary-700 dark:text-primary-500 hover:underline transition-colors duration-200">
              {% translate "See all" %} ${total_count} {% translate "results" %} â†’
            </a>
          </div>
        `;
      }

      searchResultsContent.innerHTML = html;
      searchResults.classList.remove('hidden');

      // Add click handlers to suggestion items
      searchResultsContent.querySelectorAll('[data-suggestion-item]').forEach(item => {
        item.addEventListener('click', function() {
          const productId = this.dataset.productId;
          const suggestionQuery = this.dataset.query;
          navigateToSearch(suggestionQuery, productId);
        });
      });
    }

    async function performSearch(query) {
      if (query.length < 2) {
        searchResults.classList.add('hidden');
        suggestions = [];
        return;
      }

      if (query === currentQuery) return;
      currentQuery = query;

      showLoading(true);

      try {
        const categoryId = searchCategoryIdInput?.value || '';
        let apiUrl = `{% url 'web:search_suggestions' %}?q=${encodeURIComponent(query)}`;
        if (categoryId) {
          apiUrl += `&category_id=${encodeURIComponent(categoryId)}`;
        }
        const response = await fetch(apiUrl);
        const data = await response.json();

        // Only render if this is still the current query
        if (query === currentQuery) {
          renderSearchResults(data);
        }
      } catch (error) {
        console.error('Search error:', error);
        searchResultsContent.innerHTML = `
          <div class="p-4 text-center text-sm text-red-500">
            {% translate "An error occurred. Please try again." %}
          </div>
        `;
        searchResults.classList.remove('hidden');
      } finally {
        showLoading(false);
      }
    }

    // Input event with debounce
    searchInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();
      updateClearButton();

      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }

      if (query.length < 2) {
        searchResults.classList.add('hidden');
        currentQuery = '';
        suggestions = [];
        return;
      }

      searchTimeout = setTimeout(() => {
        performSearch(query);
      }, 300);
    });

    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
      if (!searchContainer.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });

    // Show results on focus if there's content
    searchInput.addEventListener('focus', function() {
      if (searchInput.value.trim().length >= 2 && searchResultsContent.innerHTML.trim()) {
        searchResults.classList.remove('hidden');
      }
    });

    // Handle keyboard navigation
    searchInput.addEventListener('keydown', function(e) {
      const items = searchResultsContent.querySelectorAll('[data-suggestion-item]');
      const itemCount = items.length;

      if (e.key === 'Escape') {
        searchResults.classList.add('hidden');
        searchInput.blur();
        return;
      }

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!searchResults.classList.contains('hidden') && itemCount > 0) {
          selectedIndex = (selectedIndex + 1) % itemCount;
          updateSelection();
        }
        return;
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (!searchResults.classList.contains('hidden') && itemCount > 0) {
          selectedIndex = selectedIndex <= 0 ? itemCount - 1 : selectedIndex - 1;
          updateSelection();
        }
        return;
      }

      // Handle Enter key
      if (e.key === 'Enter') {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query.length >= 1) {
          // If a suggestion is selected, use it
          if (selectedIndex >= 0 && selectedIndex < suggestions.length) {
            const selected = suggestions[selectedIndex];
            navigateToSearch(selected.text, selected.id);
          } else {
            // Otherwise just search for the typed query
            navigateToSearch(query);
          }
        }
      }
    });

    // Initialize clear button visibility on page load
    updateClearButton();
  }

  // ===========================
  // NAVIGATION DROPDOWN SYSTEM
  // ===========================
  const backdrop = document.getElementById('nav-backdrop');
  // We treat the "nav bar categories area" + "dropdowns" as one interactive zone
  const navContainer = document.querySelector('.top-nav-standard'); 
  let activeDropdown = null;
  let isBackdropVisible = false;
  let lastPreviewedItem = null;
  let isScrollLocked = false;
  let initialBodyPaddingRight = '';
  let initialHtmlPaddingRight = '';
  let dropdownCloseTimeout = null; // Debounce timer for closing dropdowns
  
  // Triggers are the buttons in the top bar
  const triggers = document.querySelectorAll('.nav-category-trigger');
  const navCategoriesContainer = document.getElementById('categories-nav');
  const categoriesRowWrapper = document.getElementById('categories-row-wrapper');

  function setCategoriesRowDimmed(shouldDim) {
    if (!categoriesRowWrapper) return;
    categoriesRowWrapper.classList.toggle('is-dimmed', shouldDim);
  }
  
  function showBackdrop() {
    if (!backdrop) return;
    if (isBackdropVisible) return; // already shown
    
    backdrop.classList.remove('hidden');
    backdrop.classList.remove('pointer-events-none');
    // Force reflow
    void backdrop.offsetWidth;
    backdrop.classList.add('opacity-100');
    backdrop.classList.remove('opacity-0');
    isBackdropVisible = true;
  }

  function hideBackdrop(force = false) {
    if (!backdrop) return;
    if (!force) {
      const drawerEl = document.getElementById('categoriesDrawer');
      const drawerOpen = drawerEl && !drawerEl.classList.contains('-translate-x-full');
      const dropdownOpen = !!document.querySelector('.category-dropdown:not(.hidden)');
      if (drawerOpen || dropdownOpen) return;
    }
    if (!isBackdropVisible && !force) return;

    backdrop.classList.remove('opacity-100');
    backdrop.classList.add('opacity-0');
    backdrop.classList.add('pointer-events-none');
    isBackdropVisible = false;
  }

  const scrollLockKeys = new Set(['ArrowUp', 'ArrowDown', 'PageUp', 'PageDown', 'Home', 'End', ' ']);

  function preventScroll(e) {
    if (!isScrollLocked) return;

    const scrollable = e.target.closest('.custom-scrollbar, .overflow-y-auto, #search-results');
    if (scrollable && scrollable.scrollHeight > scrollable.clientHeight) {
      if (e.type === 'touchmove') {
        return;
      }

      const deltaY = typeof e.deltaY === 'number' ? e.deltaY : 0;
      const atTop = scrollable.scrollTop <= 0;
      const atBottom = scrollable.scrollTop + scrollable.clientHeight >= scrollable.scrollHeight - 1;

      if ((deltaY < 0 && atTop) || (deltaY > 0 && atBottom)) {
        e.preventDefault();
      }
      return;
    }

    e.preventDefault();
  }

  function preventScrollKeys(e) {
    if (!isScrollLocked) return;
    if (scrollLockKeys.has(e.key)) {
      e.preventDefault();
    }
  }

  function setScrollLocked(locked) {
    if (isScrollLocked === locked) return;
    isScrollLocked = locked;

    document.body.classList.toggle('nav-scroll-locked', locked);
    document.documentElement.classList.toggle('nav-scroll-locked', locked);

    if (locked) {
      const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
      initialBodyPaddingRight = document.body.style.paddingRight || '';
      initialHtmlPaddingRight = document.documentElement.style.paddingRight || '';
      if (scrollbarWidth > 0) {
        document.body.style.paddingRight = `${scrollbarWidth}px`;
        document.documentElement.style.paddingRight = `${scrollbarWidth}px`;
      }
      window.addEventListener('wheel', preventScroll, { passive: false });
      window.addEventListener('touchmove', preventScroll, { passive: false });
      window.addEventListener('keydown', preventScrollKeys);
    } else {
      document.body.style.paddingRight = initialBodyPaddingRight;
      document.documentElement.style.paddingRight = initialHtmlPaddingRight;
      window.removeEventListener('wheel', preventScroll);
      window.removeEventListener('touchmove', preventScroll);
      window.removeEventListener('keydown', preventScrollKeys);
    }
  }

  function closeAllDropdowns() {
    // Cancel any pending close timeout since we're actually closing now
    if (dropdownCloseTimeout) {
      clearTimeout(dropdownCloseTimeout);
      dropdownCloseTimeout = null;
    }

    document.querySelectorAll('.category-dropdown').forEach(el => {
      el.classList.add('hidden');
      el.classList.remove('is-connected');
    });

    // Close Drawer if open
    const drawer = document.getElementById('categoriesDrawer');
    if (drawer && !drawer.classList.contains('-translate-x-full')) {
        hideDrawer();
    }

    // Reset arrows
    document.querySelectorAll('.nav-dropdown-arrow').forEach(svg => {
      svg.classList.remove('rotate-180');
    });
    
    // De-activate buttons and triggers
    document.querySelectorAll('.nav-category-btn').forEach(btn => {
      btn.classList.remove('active', 'bg-gray-100', 'dark:bg-gray-700');
    });
    document.querySelectorAll('.nav-category-trigger').forEach(trigger => {
      trigger.classList.remove('is-open');
    });

    activeDropdown = null;
    lastPreviewedItem = null;
    // Delay un-dimming categories row to stay in sync with backdrop fade-out (200ms transition).
    // Without this delay, the row jumps from z-30 to z-50 instantly (above the still-fading backdrop),
    // causing a staggered hide effect.
    setTimeout(() => {
      if (!activeDropdown) {
        setCategoriesRowDimmed(false);
      }
    }, 200);

    // Unlock body scroll if mobile menu is also hidden
    const mobileMenu = document.getElementById('ecommerce-navbar-menu');
    const isMobileMenuOpen = mobileMenu && !mobileMenu.classList.contains('hidden');
    
    setScrollLocked(isMobileMenuOpen);
    window.removeEventListener('scroll', closeOnScroll);
  }

  // Debounced close: schedules closing after a short delay.
  // If another dropdown opens before the delay expires, the close is cancelled.
  // This prevents flickering of backdrop/shadow when moving between triggers.
  function scheduleCloseAllDropdowns() {
    if (dropdownCloseTimeout) {
      clearTimeout(dropdownCloseTimeout);
    }
    dropdownCloseTimeout = setTimeout(() => {
      dropdownCloseTimeout = null;
      closeAllDropdowns();
      hideBackdrop();
    }, 100); // 100ms grace period for moving between triggers
  }

  // Cancel any scheduled close (called when opening a new dropdown)
  function cancelScheduledClose() {
    if (dropdownCloseTimeout) {
      clearTimeout(dropdownCloseTimeout);
      dropdownCloseTimeout = null;
    }
  }

  function closeOnScroll() {
    if (activeDropdown) {
      closeAllDropdowns();
      hideBackdrop();
    }
  }

  function openDropdown(trigger) {
    // Cancel any pending close so we don't flicker backdrop/shadow
    cancelScheduledClose();

    // Close drawer first to avoid overlapping
    hideDrawer();

    const targetId = trigger.dataset.dropdownTarget;
    if (!targetId) return;

    // Skip cart dropdown on mobile (it should act as a link)
    if (targetId === 'cartDropdown' && window.innerWidth < 768) {
      return;
    }

    setCategoriesRowDimmed(targetId === 'cartDropdown' || targetId === 'accountDropdown');

    const dropdown = document.getElementById(targetId);

    // Toggle behavior: if clicking the same trigger that's already open, close it
    if (activeDropdown && activeDropdown === dropdown && window.innerWidth < 768) {
      closeAllDropdowns();
      hideBackdrop();
      return;
    }

    // If we have an active dropdown that is different from the target (or target doesn't exist)
    // we should close the active one.
    if (activeDropdown && activeDropdown !== dropdown) {
      activeDropdown.classList.add('hidden');
      // Reset previous trigger style
      const prevTrigger = document.querySelector(`.nav-category-trigger[data-dropdown-target="${activeDropdown.id}"]`);
      if (prevTrigger) {
         prevTrigger.classList.remove('is-open');
         const btn = prevTrigger.querySelector('.nav-category-btn');
         const arrow = prevTrigger.querySelector('.nav-dropdown-arrow');
         if (btn) btn.classList.remove('active', 'bg-gray-100', 'dark:bg-gray-700');
         if (arrow) arrow.classList.remove('rotate-180');
      }
      activeDropdown = null; // Clear it, will be set below if new one exists
    }

    if (!dropdown) return;

    if (activeDropdown !== dropdown) {
      // Position the dropdown
      if (dropdown.id === 'dropdownMegaMenu') {
        // Mega menu is full width centered
      } else if (dropdown.id === 'cartDropdown' || dropdown.id === 'accountDropdown') {
        if (window.innerWidth < 768) {
          // Mobile specific: let CSS handle positioning
          dropdown.style.position = '';
          dropdown.style.left = '';
          dropdown.style.right = '';
          dropdown.style.top = '';
          dropdown.style.width = '';
        } else {
          dropdown.style.position = '';
          dropdown.style.left = '';
          dropdown.style.right = '';
          dropdown.style.top = '';
        }
      } else {
        // Standard category dropdowns
        const btn = trigger.querySelector('.nav-category-btn');
        const rect = btn.getBoundingClientRect();
        dropdown.style.position = 'fixed';
        dropdown.style.top = `${rect.bottom - 1}px`; // Overlap by 1px
        
        // Initial positioning
        dropdown.style.left = `${rect.left}px`;
        dropdown.style.right = 'auto';
        
        // Show temporarily to measure
        dropdown.classList.remove('hidden');
        const dropdownWidth = dropdown.offsetWidth;
        
        // Check overflow
        if (rect.left + dropdownWidth > window.innerWidth - 20) {
            dropdown.style.left = 'auto';
            dropdown.style.right = `${window.innerWidth - rect.right}px`;
            dropdown.classList.add('is-right-aligned');
        } else {
            dropdown.classList.remove('is-right-aligned');
        }

        // Add class to visually connect dropdown to button
        dropdown.classList.add('is-connected');
      }

      dropdown.classList.remove('hidden');

      // FIX: Calculate available height to ensure dropdown fits in viewport
      // We calculate the distance from the top of the dropdown to the bottom of the viewport
      const rect = dropdown.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      // 16px buffer for bottom spacing
      const availableHeight = viewportHeight - rect.top - 16;
      
      // Apply the calculated height if valid
      if (availableHeight > 100) {
        dropdown.style.maxHeight = `${availableHeight}px`;
        // Only show scrollbar for simple dropdowns, not mega menu with sub-scrollers
        if (dropdown.id !== 'dropdownMegaMenu' && !dropdown.id.startsWith('categoryDropdown')) {
          dropdown.style.overflowY = 'auto';
        } else {
          dropdown.style.overflowY = 'hidden';
        }
      }

      // Style active trigger
      trigger.classList.add('is-open');
      const btn = trigger.querySelector('.nav-category-btn');
      const arrow = trigger.querySelector('.nav-dropdown-arrow');
      if (btn) btn.classList.add('active', 'bg-gray-100', 'dark:bg-gray-700');
      if (arrow) arrow.classList.add('rotate-180');
      
      activeDropdown = dropdown;
    }

    // Only show backdrop for category dropdowns, not for cart/account
    const isCartOrAccount = dropdown && (dropdown.id === 'cartDropdown' || dropdown.id === 'accountDropdown');
    if (!isCartOrAccount) {
      showBackdrop();
    }
    
    // Lock body scroll if dropdown is open (only on mobile)
    if (window.innerWidth < 768) {
      setScrollLocked(true);
    } else {
      window.addEventListener('scroll', closeOnScroll, { passive: true });
    }
  }

      // Subcategory Preview Logic
      document.addEventListener('mouseover', function(e) {
        const subItem = e.target.closest('.subcategory-item');
        if (subItem) {
          if (lastPreviewedItem === subItem) return;
          lastPreviewedItem = subItem;
    
          const parentId = subItem.dataset.parentId;
          const previewTitle = subItem.dataset.previewTitle;
          const previewUrl = subItem.dataset.previewUrl;
          const hasChildren = subItem.dataset.hasChildren === 'true';
          const previewPane = document.getElementById(`previewPane${parentId}`);
          
          if (previewPane) {
            const parentIconUrl = previewPane.dataset.categoryIconUrl || '';
            // Prepare subchildren HTML if they exist
            let subchildrenHtml = '';
            const dataContainer = subItem.querySelector('.sub-children-data');
            
            if (dataContainer && hasChildren) {
                 const treeHtml = dataContainer.innerHTML.trim();
                 if (treeHtml) {
                     subchildrenHtml = `<div class="w-full flex-1 overflow-y-auto px-6 mb-4 custom-scrollbar">${treeHtml}</div>`;
                 }
            }
    
            // Only show header and list if there are children. If no children, show button only (centered)
            let contentHtml = '';
            
            if (hasChildren) {
                contentHtml = `
                    <div class="w-full px-6 mb-2 mt-6">
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-2">${previewTitle}</h3>
                    </div>
                    ${subchildrenHtml}
                `;
            } else {
                // Empty state / Generic state
                contentHtml = `
                    <div class="h-full flex flex-col items-center justify-center p-6 text-center">
                      ${getCategoryPreviewBadgeHtml(parentIconUrl)}
                        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">${previewTitle}</h3>
                        <a href="${previewUrl}" class="inline-flex items-center justify-center w-auto px-6 py-2.5 bg-primary-700 text-white hover:bg-primary-800 text-sm font-bold rounded-lg transition-colors duration-300 shadow-sm">
                          {% translate "Go to" %} ${previewTitle}
                       </a>
                    </div>
                `;
            }
    
            previewPane.innerHTML = `
              <div class="preview-content flex flex-col items-center w-full h-full animate-fade-in">
                ${contentHtml}
              </div>
            `;
          }
        }
      });

  document.addEventListener('mouseout', function(e) {
    // No specific action needed for preview pane on simple mouseout of subitem, 
    // it will be replaced by the next hover.
  });

  // Event Listeners for Hover Intent with Delay
  // Hover intent delay prevents accidental dropdown opens when moving mouse quickly across categories
  const HOVER_INTENT_DELAY = 150; // ms - time to wait before opening dropdown
  const hoverTimeouts = new Map(); // Track pending timeouts per trigger
  
  // Track which triggers have had mouse leave at least once
  // This prevents dropdown from opening on page load when mouse is already over a category
  const triggersReady = new WeakSet();
  
  // Also track if initial page load grace period has passed
  let pageLoadGracePeriod = true;
  setTimeout(() => {
    pageLoadGracePeriod = false;
  }, 500); // 500ms after page load, allow normal hover behavior
  
  triggers.forEach(trigger => {
    trigger.addEventListener('mouseenter', () => {
      if (window.innerWidth >= 768) {
        const targetId = trigger.dataset.dropdownTarget;
        const dropdown = targetId ? document.getElementById(targetId) : null;
        if (!dropdown) {
          if (activeDropdown) {
            closeAllDropdowns();
            hideBackdrop();
          }
          return;
        }

        // During page load grace period, only allow hover if trigger is marked as ready
        // (meaning mouse has left it at least once before)
        if (pageLoadGracePeriod && !triggersReady.has(trigger)) {
          return; // Skip - mouse was already over this element on page load
        }
        
        // Clear any existing timeout for this trigger
        if (hoverTimeouts.has(trigger)) {
          clearTimeout(hoverTimeouts.get(trigger));
        }
        
        // Set a delay before opening dropdown (hover intent)
        const timeoutId = setTimeout(() => {
          openDropdown(trigger);
          hoverTimeouts.delete(trigger);
        }, HOVER_INTENT_DELAY);
        
        hoverTimeouts.set(trigger, timeoutId);
      }
    });
    
    // On click, valid for touch devices too
    trigger.addEventListener('click', (e) => {
        const targetId = trigger.dataset.dropdownTarget;
        const dropdown = targetId ? document.getElementById(targetId) : null;
        if (!dropdown) {
          if (activeDropdown) {
            closeAllDropdowns();
            hideBackdrop();
          }
          return;
        }
        
        // Mobile cart click behavior: let it navigate
        if (targetId === 'cartDropdown' && window.innerWidth < 768) {
          return; // Let the link be followed
        }

        // Keep native interactions inside dropdown content (forms, links, buttons).
        if (e.target.closest('.category-dropdown')) {
          return;
        }

        // If clicking a button inside, prevent default and open dropdown
        // If clicking a link inside, let it navigate normally
        const clickedButton = e.target.closest('button');
        const clickedLink = e.target.closest('a.nav-category-btn');
        
        if (clickedButton) {
             e.preventDefault();
             // Clear any pending hover timeout for immediate response
             if (hoverTimeouts.has(trigger)) {
               clearTimeout(hoverTimeouts.get(trigger));
               hoverTimeouts.delete(trigger);
             }
             openDropdown(trigger);
        } else if (clickedLink) {
             // Allow navigation for category links
             // Don't prevent default - let the link work normally
        }
    });

    // When leaving the trigger
    trigger.addEventListener('mouseleave', (e) => {
      // Mark this trigger as "ready" - mouse has left it once, so future hovers are intentional
      triggersReady.add(trigger);
      
      // Cancel any pending hover intent timeout
      if (hoverTimeouts.has(trigger)) {
        clearTimeout(hoverTimeouts.get(trigger));
        hoverTimeouts.delete(trigger);
      }
      
      const targetId = trigger.dataset.dropdownTarget;
      const dropdown = document.getElementById(targetId);

      // Cart dropdown can temporarily lock itself open while async cart updates are in-flight.
      if (dropdown && dropdown.id === 'cartDropdown') {
        const lockUntil = parseInt(dropdown.dataset.lockOpenUntil || '0', 10);
        if (lockUntil && Date.now() < lockUntil) {
          cancelScheduledClose();
          return;
        }
      }
      
      // Check where we are going
      const destination = e.relatedTarget;
      
      // If we are going into the dropdown associated with this trigger, don't close
      // Note: for nested dropdowns, e.relatedTarget might be the dropdown itself or a child
      if (dropdown && (dropdown === destination || dropdown.contains(destination))) {
        return;
      }

      // If we are moving to ANOTHER trigger, do NOT close everything immediately.
      // The 'mouseenter' event of the *new* trigger will handle closing other dropdowns.
      // This prevents flickering/closing when moving laterally.
      if (destination && destination.closest('.nav-category-trigger')) {
        return;
      }
      
      // Use debounced close to prevent flickering when mouse briefly passes
      // through non-trigger space between navbar elements
      scheduleCloseAllDropdowns();
    });
  });

  // Keep open when hovering the dropdown itself
  document.querySelectorAll('.category-dropdown').forEach(dropdown => {
    // Cancel scheduled close when mouse enters a dropdown
    dropdown.addEventListener('mouseenter', () => {
      cancelScheduledClose();
    });

    // When leaving the dropdown
    dropdown.addEventListener('mouseleave', (e) => {
      // If cart dropdown is locked open briefly (during async updates), ignore transient mouseleave.
      if (dropdown.id === 'cartDropdown') {
        const lockUntil = parseInt(dropdown.dataset.lockOpenUntil || '0', 10);
        if (lockUntil && Date.now() < lockUntil) {
          cancelScheduledClose();
          return;
        }
      }

      const destination = e.relatedTarget;
      
      // If we are going back to the trigger that opened this
      const trigger = document.querySelector(`.nav-category-trigger[data-dropdown-target="${dropdown.id}"]`);
      if (trigger && (trigger === destination || trigger.contains(destination))) {
        return;
      }

      // If we are moving to ANOTHER trigger (e.g. from dropdown of A to trigger B)
      // let trigger B handle the state change.
      if (destination && destination.closest('.nav-category-trigger')) {
         return;
      }
      
      // Use debounced close to prevent flickering
      scheduleCloseAllDropdowns();
    });
  });
  
  if (backdrop) {
      backdrop.addEventListener('click', () => {
          // Close on click of backdrop
          closeAllDropdowns();
          hideBackdrop();
      });
  }

  // Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeAllDropdowns();
      hideBackdrop();
    }
  });

  // ===========================
  // MOBILE MENU FUNCTIONALITY
  // ===========================
  const mobileMenu = document.getElementById('ecommerce-navbar-menu');
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenuClose = document.getElementById('mobile-menu-close');
  const topNav = document.querySelector('.top-nav-standard');

  function openMobileMenu() {
    if (!mobileMenu) return;
    mobileMenu.classList.remove('hidden');
    mobileMenu.classList.add('flex');
    setScrollLocked(true);
  }

  function closeMobileMenu() {
    if (!mobileMenu) return;
    mobileMenu.classList.add('hidden');
    mobileMenu.classList.remove('flex');
    setScrollLocked(false);
  }

  // Toggle button in navbar
  if (mobileMenuToggle) {
    mobileMenuToggle.addEventListener('click', (e) => {
      e.preventDefault();
      if (mobileMenu.classList.contains('hidden')) {
        openMobileMenu();
      } else {
        closeMobileMenu();
      }
    });
  }

  // Close button inside menu
  if (mobileMenuClose) {
    mobileMenuClose.addEventListener('click', closeMobileMenu);
  }

  // Handle category expand/collapse with delegation
  if (mobileMenu) {
    mobileMenu.addEventListener('click', function(e) {
      const btn = e.target.closest('.mobile-category-toggle');
      if (!btn) return;
      
      e.preventDefault();
      const parentLi = btn.closest('li');
      if (!parentLi) return;
      
      const submenu = parentLi.querySelector(':scope > ul');
      const arrow = btn.querySelector('svg');
      
      if (submenu) {
        submenu.classList.toggle('hidden');
        if (arrow) {
          arrow.classList.toggle('rotate-180');
        }
        
        // Scroll the parent item into view if it was opened
        if (!submenu.classList.contains('hidden')) {
          setTimeout(() => {
            parentLi.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        }
      }
    });
    
    // Close menu when clicking a link (navigation)
    mobileMenu.addEventListener('click', function(e) {
      const link = e.target.closest('a[href]');
      if (link && !link.getAttribute('href').startsWith('#')) {
        closeMobileMenu();
      }
    });
  }

  // Close mobile menu on resize to desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth >= 768 && mobileMenu && !mobileMenu.classList.contains('hidden')) {
      closeMobileMenu();
    }
  });

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && mobileMenu && !mobileMenu.classList.contains('hidden')) {
      closeMobileMenu();
    }
  });

  // ===========================
  // CATEGORIES FIT-TO-WIDTH (applies to both standard and custom modes)
  // ===========================
  if (navCategoriesContainer) {
    const navItems = Array.from(navCategoriesContainer.querySelectorAll('.nav-priority-item'));
    const navContainer = document.getElementById('categories-nav-container');
    const navbarMode = navCategoriesContainer.dataset.navbarMode;
    let resizeRaf = null;

    function resetItems() {
      navItems.forEach((item) => {
        item.style.display = '';
        item.classList.remove('is-hidden-by-width');
      });
    }

    function resetCustomModeStyles() {
      // Reset to default max-w-7xl layout
      if (navContainer) {
        navContainer.classList.remove('w-full');
        navContainer.classList.add('max-w-7xl');
      }
      navCategoriesContainer.classList.remove('justify-center');
    }

    function applyExpandedCustomMode() {
      // Expand to full width and center
      if (navContainer) {
        navContainer.classList.remove('max-w-7xl');
        navContainer.classList.add('w-full');
      }
      navCategoriesContainer.classList.add('justify-center');
    }

    function updateFit() {
      if (!navItems.length) return;
      resetItems();
      
      // For custom mode: first check if items fit in default max-w-7xl
      if (navbarMode === 'custom') {
        resetCustomModeStyles();
      }
      
      if (!navCategoriesContainer.clientWidth) return;

      // Check if items overflow
      const overflows = navCategoriesContainer.scrollWidth > navCategoriesContainer.clientWidth;
      
      // For custom mode: if overflows, try expanding to full width first
      if (navbarMode === 'custom' && overflows) {
        applyExpandedCustomMode();
        
        // Re-check after expanding - if still overflows, hide items from right
        if (navCategoriesContainer.scrollWidth > navCategoriesContainer.clientWidth) {
          let idx = navItems.length - 1;
          while (idx >= 0 && navCategoriesContainer.scrollWidth > navCategoriesContainer.clientWidth) {
            const item = navItems[idx];
            item.style.display = 'none';
            item.classList.add('is-hidden-by-width');
            idx -= 1;
          }
        }
      } else if (overflows) {
        // Standard mode: just hide items from right
        let idx = navItems.length - 1;
        while (idx >= 0 && navCategoriesContainer.scrollWidth > navCategoriesContainer.clientWidth) {
          const item = navItems[idx];
          item.style.display = 'none';
          item.classList.add('is-hidden-by-width');
          idx -= 1;
        }
      }
    }

    updateFit();
    window.addEventListener('resize', () => {
      if (resizeRaf) cancelAnimationFrame(resizeRaf);
      resizeRaf = requestAnimationFrame(updateFit);
    });
    window.addEventListener('load', updateFit);
  }

  // ===========================
  // CATEGORIES DRAWER FUNCTIONALITY
  // ===========================
  const drawer = document.getElementById('categoriesDrawer');
  const drawerToggles = document.querySelectorAll('[data-drawer-target="categoriesDrawer"]');
  const drawerHideButtons = document.querySelectorAll('[data-drawer-hide="categoriesDrawer"]');
  const drawerCollapseToggles = document.querySelectorAll('[data-collapse-toggle^="drawer-"]');

  function removeDrawerBackdrops() {
    document.querySelectorAll('[drawer-backdrop]').forEach(el => el.remove());
  }

  function showDrawer() {
    if (!drawer) return;
    removeDrawerBackdrops();
    
    // Close any active dropdowns first to ensure clean state
    document.querySelectorAll('.category-dropdown').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('.nav-dropdown-arrow').forEach(svg => svg.classList.remove('rotate-180'));
    document.querySelectorAll('.nav-category-btn').forEach(btn => btn.classList.remove('active', 'bg-gray-100', 'dark:bg-gray-700'));
    document.querySelectorAll('.nav-category-trigger').forEach(trigger => trigger.classList.remove('is-open'));
    activeDropdown = null;

    drawer.classList.remove('-translate-x-full');
    
    const navbarMain = document.querySelector('.top-nav-standard');
    const rowWrapper = document.getElementById('categories-row-wrapper');
    const drawerQuick = document.getElementById('categories-drawer-quick');

    // Lock main nav in place while drawer is open
    let navTopOffset = 0;
    if (navbarMain) {
      const navStyles = window.getComputedStyle(navbarMain);
      navTopOffset = parseFloat(navStyles.top) || 0;

      navbarMain.dataset.drawerPrevPosition = navbarMain.style.position || '';
      navbarMain.dataset.drawerPrevTop = navbarMain.style.top || '';
      navbarMain.dataset.drawerPrevLeft = navbarMain.style.left || '';
      navbarMain.dataset.drawerPrevRight = navbarMain.style.right || '';
      navbarMain.dataset.drawerPrevWidth = navbarMain.style.width || '';
      navbarMain.dataset.drawerPrevZ = navbarMain.style.zIndex || '';

      navbarMain.style.position = 'fixed';
      navbarMain.style.top = `${navTopOffset}px`;
      navbarMain.style.left = '0';
      navbarMain.style.right = '0';
      navbarMain.style.width = '100%';
      navbarMain.style.zIndex = '50';
    }

    // Hide the horizontal categories row while drawer is open
    if (rowWrapper) {
      rowWrapper.dataset.drawerPrevDisplay = rowWrapper.style.display || '';
      rowWrapper.style.display = 'none';
    }

    if (drawerQuick) {
      drawerQuick.classList.remove('is-visible');
    }

    // Show backdrop over the rest of the page (including the menu)
    if (backdrop) {
      backdrop.style.top = '0';
      backdrop.style.height = '100%';
      backdrop.classList.remove('z-45');
      backdrop.classList.add('z-[70]');
      showBackdrop();
    }
    setScrollLocked(true);
  }

  function hideDrawer() {
    if (!drawer) return;
    drawer.classList.add('-translate-x-full');
    
    // Reset backdrop positioning and hide it
    if (backdrop) {
        // Force hide backdrop logic regardless of previous state to ensure clean close
        hideBackdrop(true);
        backdrop.style.top = '';
        backdrop.style.height = '';
      backdrop.classList.remove('z-[70]');
      backdrop.classList.add('z-45');
    }
    // Restore nav + categories row positioning
    const navbarMain = document.querySelector('.top-nav-standard');
    if (navbarMain && 'drawerPrevPosition' in navbarMain.dataset) {
      navbarMain.style.position = navbarMain.dataset.drawerPrevPosition;
      navbarMain.style.top = navbarMain.dataset.drawerPrevTop;
      navbarMain.style.left = navbarMain.dataset.drawerPrevLeft;
      navbarMain.style.right = navbarMain.dataset.drawerPrevRight;
      navbarMain.style.width = navbarMain.dataset.drawerPrevWidth;
      navbarMain.style.zIndex = navbarMain.dataset.drawerPrevZ;

      delete navbarMain.dataset.drawerPrevPosition;
      delete navbarMain.dataset.drawerPrevTop;
      delete navbarMain.dataset.drawerPrevLeft;
      delete navbarMain.dataset.drawerPrevRight;
      delete navbarMain.dataset.drawerPrevWidth;
      delete navbarMain.dataset.drawerPrevZ;
    }

    const rowWrapper = document.getElementById('categories-row-wrapper');
    if (rowWrapper && 'drawerPrevDisplay' in rowWrapper.dataset) {
      rowWrapper.style.display = rowWrapper.dataset.drawerPrevDisplay;
      delete rowWrapper.dataset.drawerPrevDisplay;
    }

    removeDrawerBackdrops();
    setScrollLocked(false);
    // Ensure Flowbite's overflow-hidden is also removed from body
    document.body.classList.remove('overflow-hidden');
    
    // Force re-evaluate categories row visibility after drawer closes
    // This ensures the row shows/hides correctly based on scroll position
    setTimeout(() => {
      const rowWrapper = document.getElementById('categories-row-wrapper');
      const drawerQuick = document.getElementById('categories-drawer-quick');
      const navbarMain = document.querySelector('.top-nav-standard');
      if (rowWrapper && drawerQuick && navbarMain) {
        const currentScrollY = Math.max(0, window.scrollY);
        const rowHeight = rowWrapper.offsetHeight;
        const shouldHide = currentScrollY > rowHeight;
        
        if (shouldHide) {
          rowWrapper.style.transform = 'translateY(-100%)';
          rowWrapper.style.opacity = '0';
          rowWrapper.style.pointerEvents = 'none';
          drawerQuick.classList.add('is-visible');
          navbarMain.classList.add('shadow-md');
        } else {
          rowWrapper.style.transform = 'translateY(0)';
          rowWrapper.style.opacity = '1';
          rowWrapper.style.pointerEvents = '';
          drawerQuick.classList.remove('is-visible');
          navbarMain.classList.remove('shadow-md');
        }
      }
    }, 50);
  }

  drawerToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
          e.preventDefault();
          showDrawer();
      });
  });
  
  drawerHideButtons.forEach(btn => {
      btn.addEventListener('click', () => {
          hideDrawer();
      });
  });

  // ===========================
  // STICKY CATEGORIES NAV LOGIC
  // ===========================
  const drawerQuick = document.getElementById('categories-drawer-quick');
  const rowWrapper = document.getElementById('categories-row-wrapper');
  const navbarMain = document.querySelector('.top-nav-standard');
  
  if (drawerQuick && rowWrapper && navbarMain) {
    let isHidden = null;

    // We don't need a spacer for sticky positioning as it stays in flow
    // Remove spacer if it exists (cleanup from previous version)
    const existingSpacer = document.getElementById('categories-nav-spacer');
    if (existingSpacer) {
        existingSpacer.remove();
    }

    const updateLayout = () => {
       const navHeight = navbarMain.offsetHeight;
       
       // Position Row Wrapper Sticky
       rowWrapper.style.position = 'sticky';
       rowWrapper.style.top = `${navHeight}px`; // Stick exactly below the main nav
       rowWrapper.style.zIndex = '50'; // Same level as nav, above backdrop (z-45)
       
       // Reset width/left which might have been set by fixed logic
       rowWrapper.style.width = '100%';
       rowWrapper.style.left = '';
    };

    const updateNav = () => {
       // Don't hide categories row when drawer is open
       const drawer = document.getElementById('categoriesDrawer');
       const isDrawerOpen = drawer && !drawer.classList.contains('-translate-x-full');
       
       const currentScrollY = Math.max(0, window.scrollY);
       const rowHeight = rowWrapper.offsetHeight;
       
       // Show categories row ONLY when at the very top of the page
       // or when the drawer is open
       const shouldHide = currentScrollY > rowHeight && !isDrawerOpen;

       if (shouldHide !== isHidden) {
          isHidden = shouldHide;
          if (isHidden) {
             // Slide up and fade out together
             rowWrapper.style.transform = 'translateY(-100%)';
             rowWrapper.style.opacity = '0';
             rowWrapper.style.pointerEvents = 'none';
             drawerQuick.classList.add('is-visible');
             // Add shadow to the main nav when categories row is hidden
             navbarMain.classList.add('shadow-md');
          } else {
             // Slide down and fade in together
             rowWrapper.style.transform = 'translateY(0)';
             rowWrapper.style.opacity = '1';
             rowWrapper.style.pointerEvents = '';
             drawerQuick.classList.remove('is-visible');
             // Remove shadow from main nav when categories row is visible
             navbarMain.classList.remove('shadow-md');
          }
       }
    };

    // Initial calculations
    window.addEventListener('load', updateLayout);
    window.addEventListener('resize', () => {
        updateLayout();
        updateNav();
    });
    
    // Run immediately
    updateLayout();

    // Scroll Handler
    let ticking = false;
    window.addEventListener('scroll', () => {
        if (!ticking) {
            window.requestAnimationFrame(() => {
                updateNav();
                ticking = false;
            });
            ticking = true;
        }
    }, { passive: true });
    
    updateNav();
  }
});
</script>


