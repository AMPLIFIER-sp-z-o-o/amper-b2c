{# Password strength meter (4 bars + requirements). #}
{# Place after the password input's <div class="relative"> wrapper. #}
{# Required context: password_input_id #}
{# Optional context: email_input_id (enables "cannot contain email" check) #}
{% load i18n %}
<div id="password-strength-container" class="mt-2 hidden">
  <div class="flex gap-1 mb-1">
    <div id="str-bar-1" class="h-1 flex-1 rounded-full bg-gray-200 dark:bg-gray-600 transition-all duration-300"></div>
    <div id="str-bar-2" class="h-1 flex-1 rounded-full bg-gray-200 dark:bg-gray-600 transition-all duration-300"></div>
    <div id="str-bar-3" class="h-1 flex-1 rounded-full bg-gray-200 dark:bg-gray-600 transition-all duration-300"></div>
    <div id="str-bar-4" class="h-1 flex-1 rounded-full bg-gray-200 dark:bg-gray-600 transition-all duration-300"></div>
  </div>
  <p id="password-strength-text" class="text-xs text-gray-500 dark:text-gray-400"></p>
</div>
<div id="password-requirements" class="mt-2 space-y-1">
  <div class="flex items-center gap-1.5" id="req-length">
    <svg class="w-3.5 h-3.5 text-gray-400 dark:text-gray-500 shrink-0 req-icon" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4"/></svg>
    <svg class="w-3.5 h-3.5 text-green-500 shrink-0 req-check hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
    <span class="text-xs text-gray-500 dark:text-gray-400">{% translate "Minimum 8 characters" %}</span>
  </div>
  {% if email_input_id %}
  <div class="flex items-center gap-1.5 hidden" id="req-no-email">
    <svg class="w-3.5 h-3.5 text-red-500 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>
    <span class="text-xs text-red-600 dark:text-red-400">{% translate "Cannot contain your email" %}</span>
  </div>
  {% endif %}
</div>
<script>
(function() {
  var passwordInput = document.getElementById('{{ password_input_id }}');
  {% if email_input_id %}
  var emailInput = document.getElementById('{{ email_input_id }}');
  {% endif %}
  var strengthContainer = document.getElementById('password-strength-container');
  var strengthText = document.getElementById('password-strength-text');
  var bars = [
    document.getElementById('str-bar-1'),
    document.getElementById('str-bar-2'),
    document.getElementById('str-bar-3'),
    document.getElementById('str-bar-4'),
  ];
  var reqLength = document.getElementById('req-length');
  {% if email_input_id %}
  var reqNoEmail = document.getElementById('req-no-email');
  {% endif %}

  var strengthLabels = [
    '{% translate "Too short" %}',
    '{% translate "Weak" %}',
    '{% translate "Fair" %}',
    '{% translate "Good" %}',
    '{% translate "Strong" %}',
  ];
  var strengthColors = [
    'bg-red-500',
    'bg-orange-500',
    'bg-yellow-500',
    'bg-green-400',
    'bg-green-500',
  ];

  {% if email_input_id %}
  function getEmailLocal() {
    var email = (emailInput ? emailInput.value : '').trim().toLowerCase();
    var atIdx = email.indexOf('@');
    return atIdx > 0 ? email.substring(0, atIdx) : email;
  }
  {% endif %}

  function calcStrength(pw) {
    if (pw.length < 8) return 0;
    var score = 1;
    if (pw.length >= 10) score++;
    if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
    if (/\d/.test(pw)) score++;
    if (/[^A-Za-z0-9]/.test(pw)) score++;
    return Math.min(score, 4);
  }

  function setReq(el, passed) {
    var icon = el.querySelector('.req-icon');
    var check = el.querySelector('.req-check');
    if (passed) {
      icon.classList.add('hidden');
      check.classList.remove('hidden');
    } else {
      icon.classList.remove('hidden');
      check.classList.add('hidden');
    }
  }

  function updateStrength() {
    var pw = passwordInput.value;
    if (!pw) {
      strengthContainer.classList.add('hidden');
      {% if email_input_id %}
      reqNoEmail.classList.add('hidden');
      {% endif %}
      setReq(reqLength, false);
      return;
    }
    strengthContainer.classList.remove('hidden');
    setReq(reqLength, pw.length >= 8);

    {% if email_input_id %}
    var emailLocal = getEmailLocal();
    var hasNoEmail = !emailLocal || emailLocal.length < 3 || !pw.toLowerCase().includes(emailLocal);
    if (!hasNoEmail) {
      reqNoEmail.classList.remove('hidden');
    } else {
      reqNoEmail.classList.add('hidden');
    }
    {% endif %}

    var strength = calcStrength(pw);
    bars.forEach(function(bar, i) {
      bar.className = bar.className.replace(/bg-\S+/g, '').trim();
      if (i <= strength - 1) {
        bar.classList.add(strengthColors[strength]);
      } else {
        bar.classList.add('bg-gray-200');
        bar.classList.add('dark:bg-gray-600');
      }
      bar.classList.add('h-1', 'flex-1', 'rounded-full', 'transition-all', 'duration-300');
    });
    strengthText.textContent = strengthLabels[strength];
  }

  {% if email_input_id %}
  var userHasTypedPassword = false;
  passwordInput.addEventListener('input', function() {
    userHasTypedPassword = true;
    updateStrength();
  });
  if (emailInput) emailInput.addEventListener('input', function() {
    if (userHasTypedPassword) updateStrength();
  });
  {% else %}
  passwordInput.addEventListener('input', updateStrength);
  {% endif %}
})();
</script>
