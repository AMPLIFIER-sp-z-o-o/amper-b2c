{% extends "web/base.html" %}
{% load i18n %}
{% load static %}
{% load media_tags %}

{% block page_head %}
  {% include "account/includes/auth_card_css.html" %}
{% endblock %}

{% block body %}
<section class="bg-gray-50 dark:bg-gray-900">
  <div class="grid max-w-7xl px-4 py-8 mx-auto lg:gap-20 lg:py-16 lg:grid-cols-12">
    <div class="w-full place-self-center lg:col-span-6">
      <div class="p-6 mx-auto bg-white rounded-lg shadow dark:bg-gray-800 sm:max-w-xl sm:p-8 animate-auth-card">
        <a href="{% url 'web:home' %}" class="inline-flex items-center mb-4 text-2xl font-semibold text-gray-900 dark:text-white">
          {% if site_logo %}
          <img class="w-20 h-20 mr-3 object-contain" src="{{ site_logo }}" alt="{{ project_meta.NAME }}">
          {% endif %}
          {{ project_meta.NAME|default:"" }}
        </a>

        <h1 class="mb-2 text-2xl font-bold leading-tight tracking-tight text-gray-900 dark:text-white">
          {% translate "E-mail Addresses" %}
        </h1>

        <p class="text-subtitle mt-1">
          {% translate "Manage the email addresses associated with your account." %}
        </p>

        {% if form.non_field_errors %}
        <div class="mt-4 p-3 text-sm text-red-600 bg-red-50 dark:bg-red-900/30 dark:text-red-400 rounded-lg">
          {% for error in form.non_field_errors %}
            <p>{{ error }}</p>
          {% endfor %}
        </div>
        {% endif %}
  {% if user.emailaddress_set.all %}
  <p class="text-sm font-medium text-gray-700 dark:text-gray-200 mt-4">{% translate 'The following e-mail addresses are associated with your account:' %}</p>
  <form action="{% url 'account_email' %}" class="mt-4 space-y-3" method="post">
    {% csrf_token %}
    <fieldset>
      {% for emailaddress in user.emailaddress_set.all %}
        <label for="email_radio_{{ forloop.counter }}" class="flex items-center gap-3 rounded-lg border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/30 px-3 py-2 cursor-pointer">
          <input id="email_radio_{{ forloop.counter }}" type="radio" name="email"
                 class="w-4 h-4 accent-primary-600"
                 {% if emailaddress.primary or user.emailaddress_set.count == 1 %}checked="checked"{% endif %}
                 value="{{ emailaddress.email }}"/>
          <div class="min-w-0">
            <p class="text-sm font-medium text-gray-700 dark:text-gray-200 truncate">{{ emailaddress.email }}</p>
            <div class="mt-1 flex flex-wrap items-center gap-2">
              {% if emailaddress.verified %}
                <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-0.5 text-xs font-semibold text-green-700 dark:bg-green-900/30 dark:text-green-300">{% translate "Verified" %}</span>
              {% else %}
                <span class="inline-flex items-center rounded-md bg-gray-200 px-2 py-0.5 text-xs font-semibold text-gray-700 dark:bg-gray-600/40 dark:text-gray-200">{% translate "Unverified" %}</span>
              {% endif %}
              {% if emailaddress.primary %}
                <span class="inline-flex items-center rounded-md bg-primary-50 px-2 py-0.5 text-xs font-semibold text-primary-700 dark:bg-primary-900/30 dark:text-primary-300">{% translate "Primary" %}</span>
              {% endif %}
            </div>
          </div>
        </label>
      {% endfor %}
      <div class="mt-4 flex flex-wrap gap-2">
        <button type="submit" name="action_primary" class="inline-flex items-center justify-center gap-2 text-white bg-primary-600 hover:bg-primary-700 dark:bg-primary-600 dark:hover:bg-primary-700 rounded-lg text-sm font-semibold px-4 py-2 transition-colors cursor-pointer btn-press">
          {% translate 'Make Primary' %}
        </button>
        <button type="submit" name="action_send" class="inline-flex items-center justify-center gap-2 text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg text-sm font-semibold px-4 py-2 transition-colors cursor-pointer btn-press">
          {% translate 'Re-send Verification' %}
        </button>
        <button type="button" id="remove-email-btn" class="inline-flex items-center justify-center gap-2 text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg text-sm font-semibold px-4 py-2 transition-colors cursor-pointer btn-press">
          {% translate 'Remove' %}
        </button>
        <button type="submit" name="action_remove" id="remove-email-submit" class="hidden"></button>
      </div>
    </fieldset>
  </form>

{# Remove Email Confirmation Modal #}
<div id="remove-email-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" id="remove-email-backdrop"></div>
  <div class="fixed inset-0 flex items-center justify-center p-4">
    <div class="relative w-full max-w-sm bg-white dark:bg-gray-800 rounded-2xl shadow-2xl">
      <div class="p-6 text-center">
        <div class="flex items-center justify-center w-14 h-14 mx-auto mb-4 rounded-full bg-red-100 dark:bg-red-900/30">
          <svg class="w-7 h-7 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </div>
        <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2">{% translate "Remove E-mail?" %}</h3>
        <p class="text-subtitle mb-6">{% translate "Do you really want to remove the selected e-mail address?" %}</p>
        <div class="flex gap-3">
          <button type="button" id="remove-email-cancel" class="flex-1 px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors cursor-pointer">
            {% translate "Cancel" %}
          </button>
          <button type="button" id="remove-email-confirm" class="flex-1 px-4 py-3 text-sm font-semibold text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors cursor-pointer">
            {% translate "Remove" %}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
  <div class="mt-4 flex items-start gap-3 rounded-lg bg-amber-50 px-4 py-3 dark:bg-amber-900/30">
    <svg class="h-5 w-5 shrink-0 text-amber-600 dark:text-amber-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M12 3a9 9 0 100 18 9 9 0 000-18z"/>
    </svg>
    <p class="text-sm font-medium text-amber-800 dark:text-amber-200">
      {% translate "You currently do not have any e-mail address set up. Add one so you can receive notifications and reset your password." %}
    </p>
  </div>
{% endif %}
{% if can_add_email %}
  <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
    <h2 class="text-lg font-bold text-gray-900 dark:text-white">{% translate "Add E-mail Address" %}</h2>
    <form method="post" action="{% url 'account_email' %}" class="mt-4 space-y-4">
      {% csrf_token %}
      <div>
        <label for="{{ form.email.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{% translate "Email" %}</label>
        <input type="email" name="{{ form.email.html_name }}" id="{{ form.email.id_for_label }}" value="{{ form.email.value|default:'' }}" autocomplete="email" class="bg-gray-100 border-none text-gray-900 text-base rounded-lg focus:bg-white focus:ring-0 focus:shadow-[0_4px_8px_0_rgba(0,0,0,0.16),0_0_2px_1px_rgba(0,0,0,0.08)] block w-full p-2.5 dark:bg-gray-700 dark:placeholder-gray-400 dark:text-white dark:focus:bg-gray-600 dark:focus:shadow-[0_4px_10px_-2px_rgb(0_0_0/0.5)] transition-all duration-200" placeholder="{% translate 'Enter your email' %}" required>
        {% if form.email.errors %}
        <p class="mt-2 text-sm text-red-600 dark:text-red-400">{{ form.email.errors.0 }}</p>
        {% endif %}
      </div>
      <button id="add-email-btn" name="action_add" type="submit" class="w-full inline-flex items-center justify-center gap-2 text-white bg-primary-600 hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 font-semibold rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 cursor-pointer transition-all duration-200">
        <svg id="add-email-spinner" class="hidden w-4 h-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <span>{% translate "Add E-mail" %}</span>
      </button>
      {% include "account/includes/form_submit_loading.html" with btn_id="add-email-btn" spinner_id="add-email-spinner" %}
    </form>
  </div>
{% endif %}
      </div>
    </div>
    <div class="mr-auto place-self-center lg:col-span-6">
      <img class="hidden mx-auto lg:flex" src="{% media_file_url 'site/seed/auth-illustration.svg' %}" alt="illustration">
    </div>
  </div>
</section>
{% endblock %}
{% block page_js %}
  <script>
    (function () {
      var removeBtn = document.getElementById('remove-email-btn');
      var modal = document.getElementById('remove-email-modal');
      var cancelBtn = document.getElementById('remove-email-cancel');
      var backdrop = document.getElementById('remove-email-backdrop');
      var confirmBtn = document.getElementById('remove-email-confirm');
      var hiddenSubmit = document.getElementById('remove-email-submit');

      function showModal() { if (modal) modal.classList.remove('hidden'); }
      function hideModal() { if (modal) modal.classList.add('hidden'); }

      if (removeBtn) removeBtn.addEventListener('click', showModal);
      if (cancelBtn) cancelBtn.addEventListener('click', hideModal);
      if (backdrop) backdrop.addEventListener('click', hideModal);
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function () {
          hideModal();
          if (hiddenSubmit) hiddenSubmit.click();
        });
      }
    })();
  </script>
{% endblock %}
